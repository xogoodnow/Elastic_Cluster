version: "3.8"

services:
  elastic-{{ ansible_play_hosts_all.index(inventory_hostname) + 1 }}:
    container_name: elastic-{{ ansible_play_hosts_all.index(inventory_hostname) + 1 }}
    image: "{{ ELASTIC_BASE_IMAGE }}:{{ ELASTIC_VERSION }}"
    volumes:
      - "{{ ELASTICSEARCH_BASE_DIRECTORY }}Elasticsearch/Config/Certs:/usr/share/elasticsearch/config/certs"
      - "{{ ELASTICSEARCH_BASE_DIRECTORY }}Elasticsearch/Elasticsearch_Data/:/var/elasticsearch/data"
      - "{{ ELASTICSEARCH_BASE_DIRECTORY }}Elasticsearch/Config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml"
    environment:
      - ELASTIC_PASSWORD={{ ELASTIC_PASSWORD }}
    network_mode: host
    logging:
      driver: json-file
      options:
        max-size: "20g"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -s --cacert /usr/share/elasticsearch/config/certs/ca/ca.crt https://localhost:9200 | grep -q 'missing authentication credentials'",
        ]
      interval: 10s
      timeout: 10s
      retries: 120

  kibana-{{ ansible_play_hosts_all.index(inventory_hostname) + 1 }}:
    container_name:  kibana-{{ ansible_play_hosts_all.index(inventory_hostname) + 1 }}
    image: "{{ KIBANA_BASE_IMAGE }}:{{ KIBANA_VERSION }}"
    volumes:
      - "{{ ELASTICSEARCH_BASE_DIRECTORY }}Elasticsearch/Config/Certs:/usr/share/kibana/config/certs"
      - "{{ ELASTICSEARCH_BASE_DIRECTORY }}Elasticsearch/Kibana/Kibana_Data:/usr/share/kibana/data"

    network_mode: host
    environment:
      - SERVERNAME=kibana
      - ELASTICSEARCH_HOSTS=https://elastic-{{ ansible_play_hosts_all.index(inventory_hostname) + 1 }}-public:9200
      - ELASTICSEARCH_USERNAME={{ KIBANA_SYSTEM_USERNAME }}
      - ELASTICSEARCH_PASSWORD={{ KIBANA_PASSWORD }}
      - ELASTICSEARCH_SSL_CERTIFICATEAUTHORITIES=/usr/share/kibana/config/certs/ca/ca.crt
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -s -I http://localhost:5601 | grep -q 'HTTP/1.1 302 Found'",
        ]
      interval: 10s
      timeout: 10s
      retries: 120
    logging:
      driver: json-file
      options:
        max-size: "10g"